import telebot
import requests
import time
import threading
from flask import Flask

# ------------------------------------------------
# Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ ğŸ‘‡
BOT_TOKEN = "8246425608:AAH3uute8-j4FK1m_cRAd78w-ZFPhUULq2M"
# ------------------------------------------------

bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")

# Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
signals = {
    "BTCUSDT": {"stop": 25, "target": 80},
    "XAUUSD": {"stop": 20, "target": 60},
    "US30": {"stop": 30, "target": 100},
    "US100": {"stop": 20, "target": 70}
}

# ---- Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Binance ----
def fetch_price(symbol):
    try:
        url = f"https://api.binance.com/api/v3/ticker/price?symbol={symbol}"
        res = requests.get(url, timeout=5)
        data = res.json()
        return float(data['price'])
    except Exception as e:
        print("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e)
        return None

# ---- ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø¹Ø± ÙˆØ³ÙŠÙˆÙ„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ----
def analyze_market(symbol):
    price = fetch_price(symbol)
    if not price:
        return None

    # ØªÙˆÙ„ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ ØªÙˆØµÙŠØ© Ø¨Ø³ÙŠØ·
    action = "Ø´Ø±Ø§Ø¡ ğŸŸ¢" if int(price) % 2 == 0 else "Ø¨ÙŠØ¹ ğŸ”´"

    # ØªÙ‚Ø¯ÙŠØ± ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø³ÙŠÙˆÙ„Ø© (ØªØ¬Ø±ÙŠØ¨ÙŠ)
    liquidity_internal = round(price * 0.998, 2)
    liquidity_external = round(price * 1.002, 2)
    liquidity_third = round((liquidity_internal + liquidity_external) / 2, 2)

    stop = signals[symbol]["stop"]
    target = signals[symbol]["target"]

    return {
        "symbol": symbol,
        "price": price,
        "action": action,
        "stop": stop,
        "target": target,
        "liquidity_internal": liquidity_internal,
        "liquidity_external": liquidity_external,
        "liquidity_third": liquidity_third
    }

# ---- Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ----
@bot.message_handler(func=lambda m: m.text and m.text.upper().replace("/", "") in signals)
def send_signal(message):
    pair = message.text.upper().replace("/", "")
    info = analyze_market(pair)
    if info:
        msg = f"""ğŸ“Š <b>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚ - {info['symbol']}</b>

ğŸ”¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: {info['price']}
ğŸ”¹ Ø§Ù„ØªÙˆØµÙŠØ©: {info['action']}
ğŸ”¹ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: {info['stop']} Ù†Ù‚Ø·Ø©
ğŸ”¹ Ø§Ù„Ù‡Ø¯Ù: {info['target']} Ù†Ù‚Ø·Ø©

ğŸ“ˆ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©:
- Ø¯Ø§Ø®Ù„ÙŠØ©: {info['liquidity_internal']}
- Ø®Ø§Ø±Ø¬ÙŠØ©: {info['liquidity_external']}
- Ø³ÙŠÙˆÙ„Ø© Ø«Ø§Ù„Ø«Ø©: {info['liquidity_third']}

â±ï¸ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: 1m / 5m / 15m
"""
        bot.reply_to(message, msg)
    else:
        bot.reply_to(message, "âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¢Ù†. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.")

# ---- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ----
@bot.message_handler(func=lambda m: m.text.lower() in ["Ù…Ø±Ø­Ø¨Ø§", "Ù‡Ù„Ùˆ", "Ø³Ù„Ø§Ù…"])
def greet(message):
    bot.reply_to(message, "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬ Ù…Ø«Ù„ BTCUSDT Ø£Ùˆ XAUUSD Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠØ©.")

print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­...")

# ---- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù ----
def run_bot():
    while True:
        try:
            bot.polling(none_stop=True)
        except Exception as e:
            print("Ø®Ø·Ø£:", e)
            time.sleep(5)

threading.Thread(target=run_bot).start()

# ---- Ù„ØªØ´ØºÙŠÙ„Ù‡ 24/7 ÙÙŠ Render Ø£Ùˆ Replit ----
app = Flask(name)

@app.route("/")
def home():
    return "âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„."

if name == "main":
    app.run(host="0.0.0.0", port=8080)
